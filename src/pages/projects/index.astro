---
import Main from "@/layouts/Main.astro";
import Layout from "@/layouts/Layout.astro";
import Header from "@/layouts/components/Header.astro";
import Footer from "@/layouts/components/Footer.astro";
import ProjectCard from "@/features/projects/components/ProjectCard.astro";
import { projects } from "@/data/projects";
import { fetchProjectOgImage } from "@/utils/fetchOgImage";
import { SITE } from "@/config";

// Redirect to 404 page if `showProjects` config is false
if (!SITE.showProjects) {
  return Astro.redirect("/404");
}

// 빌드 타임에 모든 프로젝트의 OG 이미지를 fetch
const projectsWithOgImages = await Promise.all(
  projects
    .sort((a, b) => b.date.getTime() - a.date.getTime())
    .map(async project => ({
      project,
      ogImageUrl: await fetchProjectOgImage(project),
    }))
);
---

<Layout title={`Projects | ${SITE.title}`}>
  <Header />
  <Main pageTitle="Projects" pageDesc="진행한 프로젝트들입니다.">
    {
      projectsWithOgImages.length > 0 ? (
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3">
          {projectsWithOgImages.map(({ project, ogImageUrl }) => (
            <ProjectCard project={project} ogImageUrl={ogImageUrl} />
          ))}
        </div>
      ) : (
        <p class="text-center text-foreground/60">
          아직 등록된 프로젝트가 없습니다.
        </p>
      )
    }
  </Main>
  <Footer />
</Layout>
