---
// Navigation.astro
// 네비게이션 컴포넌트 - 모바일 메뉴 버튼 + 메뉴 아이템 + 토글 스크립트 통합
// 스크립트가 조작하는 모든 DOM 요소가 이 컴포넌트 안에 있어 캡슐화 완성
// 완전 독립적 - 외부 props 없이 Astro.url에서 직접 현재 경로 계산
import { Icon } from "astro-icon/components";
import LinkButton from "@/shared/components/LinkButton.astro";
import { SITE } from "@/config";
import ThemeToggle from "./ThemeToggle.astro";

const { pathname } = Astro.url;

// Remove trailing slash from current pathname if exists
const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());

  return currentPath === path || currentPathArray[0] === pathArray[0];
};
---

<nav
  class="flex w-full flex-col items-center sm:ms-2 sm:flex-row sm:justify-end sm:space-x-4 sm:py-0"
>
  <!-- 모바일 메뉴 버튼 -->
  <button
    data-menu-btn
    class="focus-outline relative self-end p-2 sm:hidden"
    aria-label="메뉴 열기"
    aria-expanded="false"
    aria-controls="menu-items"
  >
    <Icon name="ph:list-bold" data-menu-icon size={24} />
    <Icon name="ph:x" data-close-icon size={24} />
  </button>

  <!-- 메뉴 아이템 -->
  <ul
    id="menu-items"
    data-menu-items
    class:list={[
      "mt-4 flex w-44 flex-col gap-2",
      "[&>li>a]:block [&>li>a]:px-4 [&>li>a]:py-3 [&>li>a]:text-center [&>li>a]:font-medium [&>li>a]:hover:text-accent sm:[&>li>a]:px-2 sm:[&>li>a]:py-1",
      "sm:mt-0 sm:flex sm:w-auto sm:flex-row sm:gap-x-5 sm:gap-y-0",
    ]}
  >
    <li class="mobile-menu-item" style="transition-delay: 0ms;">
      <a href="/posts" class:list={{ "active-nav": isActive("/posts") }}>
        Posts
      </a>
    </li>
    <li class="mobile-menu-item" style="transition-delay: 50ms;">
      <a href="/tags" class:list={{ "active-nav": isActive("/tags") }}>
        Tags
      </a>
    </li>
    <li class="mobile-menu-item" style="transition-delay: 100ms;">
      <a href="/about" class:list={{ "active-nav": isActive("/about") }}>
        About
      </a>
    </li>
    {
      SITE.showProjects && (
        <li class="mobile-menu-item" style="transition-delay: 150ms;">
          <LinkButton
            href="/projects"
            class:list={[
              "focus-outline flex justify-center p-3 sm:p-1",
              {
                "active-nav [&>svg]:text-accent": isActive("/projects"),
              },
            ]}
            ariaLabel="projects"
            title="Projects"
          >
            <Icon name="ph:rocket-launch" class="hidden sm:inline-block" size={20} />
            <span class="sm:sr-only">Projects</span>
          </LinkButton>
        </li>
      )
    }
    <!-- Search & Theme: 모바일에서 나란히, 데스크톱에서 개별 -->
    <li class="mobile-menu-item flex items-center justify-center gap-4 sm:contents" style="transition-delay: 200ms;">
      <LinkButton
        href="/search"
        class:list={[
          "focus-outline flex p-3 sm:p-1",
          { "active-nav [&>svg]:text-accent": isActive("/search") },
        ]}
        ariaLabel="search"
        title="Search"
      >
        <Icon name="ph:magnifying-glass" size={20} />
        <span class="sr-only">Search</span>
      </LinkButton>
      <ThemeToggle />
    </li>
  </ul>
</nav>

<script>
  function toggleNav() {
    const menuBtn = document.querySelector<HTMLButtonElement>("[data-menu-btn]");
    const menuItems = document.querySelector<HTMLUListElement>("[data-menu-items]");

    if (!menuBtn || !menuItems) return;

    // 이벤트 리스너 중복 방지
    if (menuBtn.dataset.toggleNavSetup) return;
    menuBtn.dataset.toggleNavSetup = "true";

    menuBtn.addEventListener("click", () => {
      const isOpen = menuBtn.getAttribute("aria-expanded") === "true";
      const newState = !isOpen;

      // ARIA 상태 업데이트
      menuBtn.setAttribute("aria-expanded", String(newState));
      menuBtn.setAttribute("aria-label", newState ? "메뉴 닫기" : "메뉴 열기");

      // 메뉴 토글 (CSS 애니메이션으로 슬라이드 다운/업)
      menuItems.classList.toggle("mobile-menu-visible", newState);
    });

    // 데스크톱 전환 시 메뉴 상태 초기화 (리사이즈 핸들러)
    // 리스너 등록 (중복 방지)
    if (!menuBtn.dataset.resizeSetup) {
      menuBtn.dataset.resizeSetup = "true";
      const desktopQuery = window.matchMedia("(min-width: 640px)");

      desktopQuery.addEventListener("change", (e: MediaQueryListEvent) => {
        if (e.matches && menuItems && menuBtn) {
          // 데스크톱으로 전환: 메뉴 상태 초기화
          menuItems.classList.remove("mobile-menu-visible");
          menuBtn.setAttribute("aria-expanded", "false");
          menuBtn.setAttribute("aria-label", "메뉴 열기");
        }
      });
    }
  }

  toggleNav();

  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", toggleNav);
</script>

<style>
  /* ===========================================
     Mobile Menu Animation System (Scoped)
     =========================================== */

  /* 모바일 전용 애니메이션 */
  @media (max-width: 639px) {
    /* 메뉴 컨테이너 슬라이드 다운 */
    [data-menu-items] {
      max-height: 0;
      margin-top: 0;
      opacity: 0;
      overflow: hidden;
      transition:
        max-height 300ms ease-out,
        margin-top 300ms ease-out,
        opacity 200ms ease-out;
    }

    :global([data-menu-items].mobile-menu-visible) {
      max-height: 80vh;
      margin-top: 1rem;
      opacity: 1;
    }

    /* 메뉴 아이템 기본 상태 */
    .mobile-menu-item {
      opacity: 0;
      transform: translateY(-10px);
      transition:
        opacity 200ms ease-out,
        transform 200ms ease-out;
    }

    :global([data-menu-items].mobile-menu-visible) .mobile-menu-item {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* 햄버거 → X 아이콘 애니메이션 */
  [data-menu-btn] {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  @media (min-width: 640px) {
    [data-menu-btn] {
      display: none;
    }
  }

  /*
   * IMPORTANT: 두 아이콘 모두 :global() 필수
   * <Icon> 컴포넌트(astro-icon)가 렌더링하는 요소는 scoped CSS 대상에서 제외됨
   * data-menu-icon과 data-close-icon 모두 동일하게 :global() 처리 필요
   */
  :global([data-menu-icon]),
  :global([data-close-icon]) {
    transform-origin: 12px 12px;
    transition:
      transform 300ms ease-out,
      opacity 200ms ease-out;
  }

  :global([data-menu-icon]) {
    transform: scale(1) rotate(0deg);
    opacity: 1;
  }

  :global([data-close-icon]) {
    position: absolute;
    transform: scale(0) rotate(-90deg);
    opacity: 0;
    pointer-events: none;
  }

  /* 메뉴 열림 상태 */
  [data-menu-btn][aria-expanded="true"] :global([data-menu-icon]) {
    transform: scale(0) rotate(90deg);
    opacity: 0;
  }

  [data-menu-btn][aria-expanded="true"] :global([data-close-icon]) {
    transform: scale(1) rotate(0deg);
    opacity: 1;
    pointer-events: auto;
  }

  /* Reduced Motion 지원 */
  @media (prefers-reduced-motion: reduce) {
    [data-menu-items],
    .mobile-menu-item,
    :global([data-menu-icon]),
    :global([data-close-icon]) {
      transition: none;
      transition-delay: 0ms;
    }
  }
</style>
