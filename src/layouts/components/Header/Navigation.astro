---
// Navigation.astro
// 네비게이션 컴포넌트 - 모바일 메뉴 버튼 + 메뉴 아이템 + 토글 스크립트 통합
// Sheet 스타일 - 위에서 아래로 슬라이드하되 absolute로 레이아웃 쉬프트 방지
import { Icon } from "astro-icon/components";
import LinkButton from "@/shared/components/LinkButton.astro";
import { SITE } from "@/config";
import ThemeToggle from "./ThemeToggle.astro";

const { pathname } = Astro.url;

const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());
  return currentPath === path || currentPathArray[0] === pathArray[0];
};

const iconTransition =
  "origin-center transition-all duration-300 ease-out motion-reduce:transition-none";

// 메뉴 아이템 기본 스타일 + 열림 시 staggered 애니메이션
const menuItemBase =
  "sm:opacity-100 sm:translate-y-0 opacity-0 -translate-y-2.5 transition-all duration-200 ease-out motion-reduce:transition-none motion-reduce:delay-0";
---

<nav
  class="flex w-full flex-col items-center sm:ms-2 sm:flex-row sm:justify-end sm:space-x-4 sm:py-0"
>
  <!-- 모바일 메뉴 버튼 -->
  <button
    data-menu-btn
    class="group focus-outline relative flex items-center justify-center self-end p-2 sm:hidden"
    aria-label="메뉴 열기"
    aria-expanded="false"
    aria-controls="menu-items"
  >
    <Icon
      name="ph:list-bold"
      data-menu-icon
      size={24}
      class:list={[
        iconTransition,
        "scale-100 rotate-0 opacity-100",
        "group-aria-expanded:scale-0 group-aria-expanded:rotate-90 group-aria-expanded:opacity-0",
      ]}
    />
    <Icon
      name="ph:x"
      data-close-icon
      size={24}
      class:list={[
        "absolute pointer-events-none",
        iconTransition,
        "scale-0 -rotate-90 opacity-0",
        "group-aria-expanded:scale-100 group-aria-expanded:rotate-0 group-aria-expanded:opacity-100 group-aria-expanded:pointer-events-auto",
      ]}
    />
  </button>

  <!-- 메뉴 아이템 - Sheet 스타일 (위에서 아래로 슬라이드, absolute로 레이아웃 쉬프트 방지) -->
  <ul
    id="menu-items"
    data-menu-items
    data-state="closed"
    class:list={[
      "absolute left-0 right-0 top-full z-40",
      "mt-4 flex w-full flex-col items-center gap-2 bg-background pb-4 border-b border-border",
      "origin-top transition-all duration-300 ease-out",
      "[&>li>a]:block [&>li>a]:w-44 [&>li>a]:px-4 [&>li>a]:py-3 [&>li>a]:text-center [&>li>a]:font-medium [&>li>a]:hover:text-accent",
      // 데스크톱: inline flex로 복원
      "sm:static sm:z-auto sm:mt-0 sm:w-auto sm:flex-row sm:items-center sm:gap-x-5 sm:bg-transparent sm:pb-0 sm:border-none",
      "sm:[&>li>a]:w-auto sm:[&>li>a]:px-2 sm:[&>li>a]:py-1",
      "motion-reduce:transition-none",
    ]}
  >
    <li class:list={[menuItemBase, "delay-0 sm:delay-0"]}>
      <a href="/posts" class:list={{ "active-nav": isActive("/posts") }}>
        Posts
      </a>
    </li>
    <li class:list={[menuItemBase, "delay-50 sm:delay-0"]}>
      <a href="/tags" class:list={{ "active-nav": isActive("/tags") }}>
        Tags
      </a>
    </li>
    <li class:list={[menuItemBase, "delay-100 sm:delay-0"]}>
      <a href="/about" class:list={{ "active-nav": isActive("/about") }}>
        About
      </a>
    </li>
    {
      SITE.showProjects && (
        <li class:list={[menuItemBase, "delay-150 sm:delay-0"]}>
          <LinkButton
            href="/projects"
            class:list={[
              "focus-outline flex w-44 justify-center p-3 sm:w-auto sm:p-1",
              {
                "active-nav [&>svg]:text-accent": isActive("/projects"),
              },
            ]}
            ariaLabel="projects"
            title="Projects"
          >
            <Icon name="ph:rocket-launch" class="hidden sm:inline-block" size={20} />
            <span class="sm:sr-only">Projects</span>
          </LinkButton>
        </li>
      )
    }
    <!-- Search & Theme -->
    <li class:list={[menuItemBase, "delay-200 sm:delay-0", "sm:contents flex items-center justify-center gap-4"]}>
      <LinkButton
        href="/search"
        class:list={[
          "focus-outline flex p-3 sm:p-1",
          { "active-nav [&>svg]:text-accent": isActive("/search") },
        ]}
        ariaLabel="search"
        title="Search"
      >
        <Icon name="ph:magnifying-glass" size={20} />
        <span class="sr-only">Search</span>
      </LinkButton>
      <ThemeToggle />
    </li>
  </ul>
</nav>

<script>
  function toggleNav() {
    const menuBtn = document.querySelector<HTMLButtonElement>("[data-menu-btn]");
    const menuItems = document.querySelector<HTMLUListElement>("[data-menu-items]");

    if (!menuBtn || !menuItems) return;

    if (menuBtn.dataset.toggleNavSetup) return;
    menuBtn.dataset.toggleNavSetup = "true";

    function openMenu() {
      menuItems?.setAttribute("data-state", "open");
      menuBtn?.setAttribute("aria-expanded", "true");
      menuBtn?.setAttribute("aria-label", "메뉴 닫기");
    }

    function closeMenu() {
      menuItems?.setAttribute("data-state", "closed");
      menuBtn?.setAttribute("aria-expanded", "false");
      menuBtn?.setAttribute("aria-label", "메뉴 열기");
    }

    // 메뉴 버튼 클릭
    menuBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = menuBtn.getAttribute("aria-expanded") === "true";
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    // 외부 클릭 시 닫기
    document.addEventListener("click", (e) => {
      const isOpen = menuBtn?.getAttribute("aria-expanded") === "true";
      if (!isOpen) return;

      const target = e.target as Node;
      if (!menuItems?.contains(target) && !menuBtn?.contains(target)) {
        closeMenu();
      }
    });

    // Escape 키로 닫기
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && menuBtn?.getAttribute("aria-expanded") === "true") {
        closeMenu();
        menuBtn?.focus();
      }
    });

    // 데스크톱 전환 시 상태 초기화
    const desktopQuery = window.matchMedia("(min-width: 640px)");
    desktopQuery.addEventListener("change", (e: MediaQueryListEvent) => {
      if (e.matches) {
        closeMenu();
      }
    });
  }

  toggleNav();
  document.addEventListener("astro:after-swap", toggleNav);
</script>

<style>
  /* Sheet 닫힌 상태 - 위로 접힘 */
  [data-menu-items][data-state="closed"] {
    visibility: hidden;
    opacity: 0;
    max-height: 0;
    padding-bottom: 0;
    margin-top: 0;
    overflow: hidden;
    transition:
      opacity 200ms ease-out,
      max-height 300ms ease-out,
      padding-bottom 300ms ease-out,
      margin-top 300ms ease-out,
      visibility 0s linear 300ms;
  }

  /* Sheet 열린 상태 - 아래로 펼침 */
  [data-menu-items][data-state="open"] {
    visibility: visible;
    opacity: 1;
    max-height: 80vh;
    transition:
      opacity 200ms ease-out,
      max-height 300ms ease-out,
      padding-bottom 300ms ease-out,
      margin-top 300ms ease-out,
      visibility 0s linear 0s;
  }

  /* 열린 상태에서 메뉴 아이템 표시 */
  [data-menu-items][data-state="open"] > li {
    opacity: 1;
    --tw-translate-y: 0px;
  }

  /* 데스크톱에서는 항상 표시 */
  @media (min-width: 640px) {
    [data-menu-items] {
      visibility: visible !important;
      opacity: 1 !important;
      max-height: none !important;
      overflow: visible !important;
      transition: none !important;
    }

    [data-menu-items] > li {
      opacity: 1 !important;
      --tw-translate-y: 0px !important;
    }
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    [data-menu-items] {
      transition: none !important;
    }
  }
</style>
