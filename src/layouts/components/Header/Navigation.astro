---
// Navigation.astro
// 네비게이션 컴포넌트 - 모바일 메뉴 버튼 + 메뉴 아이템 + 토글 스크립트 통합
// 스크립트가 조작하는 모든 DOM 요소가 이 컴포넌트 안에 있어 캡슐화 완성
// 완전 독립적 - 외부 props 없이 Astro.url에서 직접 현재 경로 계산
import { Icon } from "astro-icon/components";
import LinkButton from "@/shared/components/LinkButton.astro";
import { SITE } from "@/config";
import ThemeToggle from "./ThemeToggle.astro";

const { pathname } = Astro.url;

// Remove trailing slash from current pathname if exists
const currentPath =
  pathname.endsWith("/") && pathname !== "/" ? pathname.slice(0, -1) : pathname;

const isActive = (path: string) => {
  const currentPathArray = currentPath.split("/").filter(p => p.trim());
  const pathArray = path.split("/").filter(p => p.trim());

  return currentPath === path || currentPathArray[0] === pathArray[0];
};

// Tailwind 클래스 상수 - 가독성과 재사용성을 위해 추출
const iconTransition =
  "origin-center transition-all duration-300 ease-out motion-reduce:transition-none";

const menuItemBase =
  "sm:opacity-100 sm:translate-y-0 opacity-0 -translate-y-2.5 transition-all duration-200 ease-out group-[.mobile-menu-visible]:opacity-100 group-[.mobile-menu-visible]:translate-y-0 motion-reduce:transition-none motion-reduce:delay-0";
---

<nav
  class="flex w-full flex-col items-center sm:ms-2 sm:flex-row sm:justify-end sm:space-x-4 sm:py-0"
>
  <!-- 모바일 메뉴 버튼 -->
  <button
    data-menu-btn
    class="group focus-outline relative flex items-center justify-center self-end p-2 sm:hidden"
    aria-label="메뉴 열기"
    aria-expanded="false"
    aria-controls="menu-items"
  >
    <Icon
      name="ph:list-bold"
      data-menu-icon
      size={24}
      class:list={[
        iconTransition,
        "scale-100 rotate-0 opacity-100",
        "group-aria-expanded:scale-0 group-aria-expanded:rotate-90 group-aria-expanded:opacity-0",
      ]}
    />
    <Icon
      name="ph:x"
      data-close-icon
      size={24}
      class:list={[
        "absolute pointer-events-none",
        iconTransition,
        "scale-0 -rotate-90 opacity-0",
        "group-aria-expanded:scale-100 group-aria-expanded:rotate-0 group-aria-expanded:opacity-100 group-aria-expanded:pointer-events-auto",
      ]}
    />
  </button>

  <!-- 메뉴 아이템 -->
  <ul
    id="menu-items"
    data-menu-items
    class:list={[
      "group",
      "mt-4 flex w-44 flex-col gap-2",
      "[&>li>a]:block [&>li>a]:px-4 [&>li>a]:py-3 [&>li>a]:text-center [&>li>a]:font-medium [&>li>a]:hover:text-accent sm:[&>li>a]:px-2 sm:[&>li>a]:py-1",
      "sm:mt-0 sm:flex sm:w-auto sm:flex-row sm:gap-x-5 sm:gap-y-0",
    ]}
  >
    <li class:list={[menuItemBase, "delay-0"]}>
      <a href="/posts" class:list={{ "active-nav": isActive("/posts") }}>
        Posts
      </a>
    </li>
    <li class:list={[menuItemBase, "delay-50"]}>
      <a href="/tags" class:list={{ "active-nav": isActive("/tags") }}>
        Tags
      </a>
    </li>
    <li class:list={[menuItemBase, "delay-100"]}>
      <a href="/about" class:list={{ "active-nav": isActive("/about") }}>
        About
      </a>
    </li>
    {
      SITE.showProjects && (
        <li class:list={[menuItemBase, "delay-150"]}>
          <LinkButton
            href="/projects"
            class:list={[
              "focus-outline flex justify-center p-3 sm:p-1",
              {
                "active-nav [&>svg]:text-accent": isActive("/projects"),
              },
            ]}
            ariaLabel="projects"
            title="Projects"
          >
            <Icon name="ph:rocket-launch" class="hidden sm:inline-block" size={20} />
            <span class="sm:sr-only">Projects</span>
          </LinkButton>
        </li>
      )
    }
    <!-- Search & Theme: 모바일에서 나란히, 데스크톱에서 개별 -->
    <li class:list={[menuItemBase, "delay-200", "sm:contents flex items-center justify-center gap-4"]}>
      <LinkButton
        href="/search"
        class:list={[
          "focus-outline flex p-3 sm:p-1",
          { "active-nav [&>svg]:text-accent": isActive("/search") },
        ]}
        ariaLabel="search"
        title="Search"
      >
        <Icon name="ph:magnifying-glass" size={20} />
        <span class="sr-only">Search</span>
      </LinkButton>
      <ThemeToggle />
    </li>
  </ul>
</nav>

<script>
  function toggleNav() {
    const menuBtn = document.querySelector<HTMLButtonElement>("[data-menu-btn]");
    const menuItems = document.querySelector<HTMLUListElement>("[data-menu-items]");

    if (!menuBtn || !menuItems) return;

    // 이벤트 리스너 중복 방지
    if (menuBtn.dataset.toggleNavSetup) return;
    menuBtn.dataset.toggleNavSetup = "true";

    menuBtn.addEventListener("click", () => {
      const isOpen = menuBtn.getAttribute("aria-expanded") === "true";
      const newState = !isOpen;

      // ARIA 상태 업데이트
      menuBtn.setAttribute("aria-expanded", String(newState));
      menuBtn.setAttribute("aria-label", newState ? "메뉴 닫기" : "메뉴 열기");

      // 메뉴 토글 (CSS 애니메이션으로 슬라이드 다운/업)
      menuItems.classList.toggle("mobile-menu-visible", newState);
    });

    // 데스크톱 전환 시 메뉴 상태 초기화 (리사이즈 핸들러)
    // 리스너 등록 (중복 방지)
    if (!menuBtn.dataset.resizeSetup) {
      menuBtn.dataset.resizeSetup = "true";
      const desktopQuery = window.matchMedia("(min-width: 640px)");

      desktopQuery.addEventListener("change", (e: MediaQueryListEvent) => {
        if (e.matches && menuItems && menuBtn) {
          // 데스크톱으로 전환: 메뉴 상태 초기화
          menuItems.classList.remove("mobile-menu-visible");
          menuBtn.setAttribute("aria-expanded", "false");
          menuBtn.setAttribute("aria-label", "메뉴 열기");
        }
      });
    }
  }

  toggleNav();

  // Runs on view transitions navigation
  document.addEventListener("astro:after-swap", toggleNav);
</script>

<style>
  /* 모바일 메뉴 슬라이드 애니메이션 (Tailwind로 대체 불가 - max-height 동적 전환) */
  @media (max-width: 639px) {
    [data-menu-items] {
      max-height: 0;
      margin-top: 0;
      opacity: 0;
      overflow: hidden;
      transition:
        max-height 300ms ease-out,
        margin-top 300ms ease-out,
        opacity 200ms ease-out;
    }

    :global([data-menu-items].mobile-menu-visible) {
      max-height: 80vh;
      margin-top: 1rem;
      opacity: 1;
    }
  }

  /* Reduced Motion: 슬라이드 애니메이션 비활성화 */
  @media (prefers-reduced-motion: reduce) {
    [data-menu-items] {
      transition: none;
    }
  }
</style>
