---
import { ClientRouter } from "astro:transitions";
import {
  PUBLIC_GOOGLE_SITE_VERIFICATION,
  PUBLIC_GOOGLE_ANALYTICS_ID,
} from "astro:env/client";
import { SITE } from "@/config";
import "@/styles/global.css";
import SonnerProvider from "@/components/SonnerProvider";

export interface Props {
  title?: string;
  description?: string;
  ogImage?: string;
  canonicalURL?: string;
  pubDatetime?: Date;
  modDatetime?: Date | null;
  scrollSmooth?: boolean;
  pageType?: "website" | "article" | "profile";
  tags?: string[];
}

const {
  title = SITE.title,
  description = SITE.desc,
  ogImage = SITE.ogImage ? `/${SITE.ogImage}` : "/og.png",
  canonicalURL = new URL(Astro.url.pathname, Astro.url),
  pubDatetime,
  modDatetime,
  scrollSmooth = false,
  pageType = "website",
  tags = [],
} = Astro.props;

// 키워드 병합: 페이지별 태그 + 사이트 기본 키워드
const keywords = tags.length > 0 ? tags : SITE.keywords;

const socialImageURL = new URL(ogImage, Astro.url);

// 페이지 타입에 따른 JSON-LD 구조화 데이터
const structuredData =
  pageType === "article"
    ? {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        headline: title,
        image: `${socialImageURL}`,
        datePublished: pubDatetime?.toISOString(),
        ...(modDatetime && { dateModified: modDatetime.toISOString() }),
        author: {
          "@type": "Person",
          name: SITE.author,
          url: SITE.profile,
        },
        publisher: {
          "@type": "Person",
          name: SITE.author,
          url: SITE.website,
        },
        ...(tags.length > 0 && { keywords: tags.join(", ") }),
      }
    : pageType === "profile"
      ? {
          "@context": "https://schema.org",
          "@type": "Person",
          name: SITE.author,
          alternateName: SITE.authorEn,
          description: SITE.authorDescription,
          url: `${SITE.website}/about`,
          image: `${socialImageURL}`,
          sameAs: [SITE.social.github, SITE.social.linkedin],
          email: `mailto:${SITE.social.email}`,
          knowsAbout: SITE.keywords,
        }
      : {
          "@context": "https://schema.org",
          "@type": "WebSite",
          name: SITE.title,
          description: SITE.desc,
          url: SITE.website,
          author: {
            "@type": "Person",
            name: SITE.author,
            url: SITE.profile,
          },
        };
---

<!doctype html>
<html
  dir={SITE.dir}
  lang=`${SITE.lang ?? "en"}`
  class={`${scrollSmooth && "scroll-smooth"}`}
>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />

    <!-- Pretendard 가변 다이나믹 서브셋 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link
      rel="preload"
      as="style"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css"
    />
    <link
      rel="stylesheet"
      crossorigin
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.min.css"
    />

    <!-- Goorm Sans Code 폰트 -->
    <link rel="preconnect" href="https://statics.goorm.io" crossorigin />
    <link
      rel="preload"
      as="style"
      crossorigin
      href="https://statics.goorm.io/fonts/GoormSansCode/v1.0.1/GoormSansCode.min.css"
    />
    <link
      rel="stylesheet"
      crossorigin
      href="https://statics.goorm.io/fonts/GoormSansCode/v1.0.1/GoormSansCode.min.css"
    />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />

    <!-- General Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <meta name="author" content={SITE.author} />
    <meta name="keywords" content={keywords.join(", ")} />
    <link rel="sitemap" href="/sitemap-index.xml" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={pageType} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={socialImageURL} />
    <meta property="og:site_name" content={SITE.title} />
    <meta property="og:locale" content="ko_KR" />

    <!-- Article Meta Tags (article 타입일 때만) -->
    {
      pageType === "article" && (
        <>
          <meta property="article:author" content={SITE.profile} />
          {tags.length > 0 && (
            <meta property="article:section" content={tags[0]} />
          )}
          {tags.map(tag => (
            <meta property="article:tag" content={tag} />
          ))}
        </>
      )
    }
    {
      pubDatetime && (
        <meta
          property="article:published_time"
          content={pubDatetime.toISOString()}
        />
      )
    }
    {
      modDatetime && (
        <meta
          property="article:modified_time"
          content={modDatetime.toISOString()}
        />
      )
    }

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={socialImageURL} />

    <!-- Google JSON-LD Structured data -->
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(structuredData)}
    />

    <!-- Enable RSS feed auto-discovery  -->
    <!-- https://docs.astro.build/en/recipes/rss/#enabling-rss-feed-auto-discovery -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title={SITE.title}
      href={new URL("rss.xml", Astro.site)}
    />

    <meta name="theme-color" content="" />

    {
      // If PUBLIC_GOOGLE_SITE_VERIFICATION is set in the environment variable,
      // include google-site-verification tag in the heading
      // Learn more: https://support.google.com/webmasters/answer/9008080#meta_tag_verification&zippy=%2Chtml-tag
      PUBLIC_GOOGLE_SITE_VERIFICATION && (
        <meta
          name="google-site-verification"
          content={PUBLIC_GOOGLE_SITE_VERIFICATION}
        />
      )
    }

    {
      // If PUBLIC_GOOGLE_ANALYTICS_ID is set in the environment variable,
      // include Google Analytics gtag script
      PUBLIC_GOOGLE_ANALYTICS_ID && (
        <>
          {/* Google tag (gtag.js) */}
          <script
            is:inline
            async
            src={`https://www.googletagmanager.com/gtag/js?id=${PUBLIC_GOOGLE_ANALYTICS_ID}`}
          />
          <script is:inline src="/gtag-init.js" />
          <script is:inline define:vars={{ GA_ID: PUBLIC_GOOGLE_ANALYTICS_ID }}>
            gtag('config', GA_ID);
          </script>
        </>
      )
    }

    <ClientRouter />

    <script is:inline>
      (function () {
        const STORAGE_KEY = "theme";
        const getStored = () => {
          try {
            return localStorage.getItem(STORAGE_KEY);
          } catch {
            return null;
          }
        };
        const setStored = v => {
          try {
            localStorage.setItem(STORAGE_KEY, v);
          } catch {}
        };
        const prefersDark = () =>
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches;

        function applyTheme(mode) {
          const isDark =
            mode === "dark" ||
            (mode === "system" || mode == null ? prefersDark() : false);
          document.documentElement.setAttribute(
            "data-theme",
            isDark ? "dark" : "light"
          );
          setStored(mode ?? "system");

          const body = document.body;
          if (body) {
            const bg = getComputedStyle(body).backgroundColor;
            const meta = document.querySelector("meta[name='theme-color']");
            if (meta && bg) meta.setAttribute("content", bg);
          }
        }

        const initMode = getStored() || "system";
        applyTheme(initMode);

        const mql = window.matchMedia
          ? window.matchMedia("(prefers-color-scheme: dark)")
          : null;
        const onSystemChange = () => {
          if ((getStored() || "system") === "system") applyTheme("system");
        };
        if (mql && mql.addEventListener)
          mql.addEventListener("change", onSystemChange);

        window.__setTheme = mode => applyTheme(mode);

        document.addEventListener("astro:before-swap", event => {
          const color =
            document
              .querySelector("meta[name='theme-color']")
              ?.getAttribute("content") || "";
          event.newDocument
            .querySelector("meta[name='theme-color']")
            ?.setAttribute("content", color);
        });
        document.addEventListener("astro:after-swap", () => {
          applyTheme(getStored() || "system");
        });
      })();
    </script>
  </head>
  <body>
    <slot />
    <SonnerProvider client:only="react" />
  </body>
</html>
