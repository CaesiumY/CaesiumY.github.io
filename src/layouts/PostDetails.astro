---
import { render, type CollectionEntry } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/layouts/components/Header.astro";
import Footer from "@/layouts/components/Footer.astro";
import ShareLinks from "@/features/blog/components/ShareLinks.astro";
import Comments from "@/features/blog/components/Comments";
import BackButton from "@/layouts/components/Navigation/BackButton.astro";
import BackToTopButton from "@/layouts/components/Navigation/BackToTopButton.astro";
import PostMetadata from "@/features/blog/components/PostMetadata.astro";
import PostNavigation from "@/features/blog/components/PostNavigation.astro";
import CopyButtonIcons from "@/features/blog/components/CopyButtonIcons.astro";
import ContinueReadingToast from "@/features/blog/components/ContinueReadingToast";
import { getPath } from "@/utils/getPath";
import { SITE } from "@/config";

export interface Props {
  post: CollectionEntry<"blog">;
  posts: CollectionEntry<"blog">[];
}

const { post, posts } = Astro.props;

const {
  title,
  description,
  ogImage: initOgImage,
  canonicalURL,
  pubDatetime,
  modDatetime,
  draft,
  tags,
} = post.data;

const { Content } = await render(post);

let ogImageUrl: string | undefined;

// Determine OG image source
if (typeof initOgImage === "string") {
  ogImageUrl = initOgImage; // Remote OG image (absolute URL)
} else if (initOgImage?.src) {
  ogImageUrl = initOgImage.src; // Local asset
}

// Use dynamic OG image if enabled and no remote|local ogImage
if (!ogImageUrl && SITE.dynamicOgImage) {
  ogImageUrl = `${getPath(post.id, post.filePath)}/index.png`;
}

// Resolve OG image URL (or fallback to SITE.ogImage / default `og.png`)
const ogImage = ogImageUrl
  ? new URL(ogImageUrl, Astro.url.origin).href
  : undefined;

const layoutProps = {
  title: `${title} | ${SITE.title}`,
  description,
  pubDatetime,
  modDatetime,
  canonicalURL,
  ogImage,
  scrollSmooth: true,
  pageType: "article" as const,
  tags,
};

---

<Layout {...layoutProps}>
  <Header />
  <BackButton />
  <main
    id="main-content"
    data-post-slug={post.id}
    class:list={[
      "mx-auto w-full max-w-app px-4 pb-12",
      { "mt-8": !SITE.showBackButton },
    ]}
    data-pagefind-body={!draft}
    data-pagefind-ignore={draft ? "all" : undefined}
  >
    <PostMetadata {post}>
      <article
        id="article"
        class="app-prose mx-auto mt-8 max-w-app prose-pre:bg-(--shiki-light-bg) dark:prose-pre:bg-(--shiki-dark-bg)"
      >
        {
          ogImageUrl && (
            <img
              src={ogImageUrl}
              alt={`${title} 썸네일`}
              width={1200}
              height={630}
              class="w-full h-auto rounded-lg mb-8"
              loading="lazy"
              decoding="async"
            />
          )
        }
        <Content />
      </article>
    </PostMetadata>

    <BackToTopButton />

    <ShareLinks />

    <Comments client:only="react" />
    <ContinueReadingToast client:only="react" slug={post.id} />

    <hr class="my-6 border-dashed" />

    <PostNavigation {posts} currentPostId={post.id} />

    <CopyButtonIcons />
  </main>
  <Footer />
</Layout>

<script>
  import { initializeProgressBar } from "@/features/blog/scripts/progressBar";
  import { addHeadingLinks } from "@/features/blog/scripts/headingLinks";
  import { attachCopyButtons } from "@/features/blog/scripts/copyButton";
  import { initializeScrollSaver } from "@/features/blog/scripts/scrollSaver";
  import { getScrollPosition } from "@/utils/scrollPosition";

  // Store cleanup function for current page
  let currentCleanup: (() => void) | null = null;

  function initializePostFeatures() {
    // Initialize all post detail features
    initializeProgressBar();
    addHeadingLinks();
    attachCopyButtons();

    // Clean up previous scroll saver if exists
    if (currentCleanup) {
      currentCleanup();
      currentCleanup = null;
    }

    // Get slug from data attribute (consistent with React component)
    const mainContent = document.getElementById('main-content');
    const slug = mainContent?.dataset.postSlug || '';

    if (slug) {
      currentCleanup = initializeScrollSaver(slug);
    }
  }

  // Run on initial load
  initializePostFeatures();

  // Run on every View Transition navigation
  document.addEventListener('astro:page-load', () => {
    // Only run on post detail pages
    if (document.getElementById('main-content')?.dataset.postSlug) {
      initializePostFeatures();
    }
  });

  // Handle scroll position on page swap
  document.addEventListener("astro:before-swap", () => {
    // Clean up before leaving
    if (currentCleanup) {
      currentCleanup();
      currentCleanup = null;
    }
  });

  // Only scroll to top if no saved position exists
  document.addEventListener("astro:after-swap", () => {
    const mainEl = document.getElementById('main-content');
    const currentSlug = mainEl?.dataset.postSlug || '';

    // Only apply scroll logic on post detail pages
    if (!currentSlug) return;

    const savedPosition = getScrollPosition(currentSlug);

    // 저장된 위치가 있으면 리셋하지 않음 (토스트가 스크롤 복원 담당)
    if (savedPosition) {
      return; // 스크롤 리셋 안 함 - 토스트 컴포넌트가 처리
    }

    // 저장된 위치가 없으면 맨 위로
    window.scrollTo({ left: 0, top: 0, behavior: "instant" });
  });
</script>
